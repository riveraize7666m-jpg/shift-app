# Shift Manager Pro - システム仕様書

## 1. 概要

**Shift Manager Pro** は、医療・介護施設向けのシフト表自動生成システムです。
複雑なシフトルールを考慮しながら、最適なシフト表を自動生成します。

### 1.1 システム構成

| コンポーネント | 技術スタック |
|--------------|------------|
| フロントエンド | Next.js 16, React, TypeScript, Tailwind CSS |
| バックエンド | FastAPI, Python 3.11+ |
| 通信 | REST API (JSON) |

### 1.2 ディレクトリ構成

```
pes/
├── api.py                 # FastAPI メインエントリポイント
├── backend/               # バックエンドロジック
│   ├── __init__.py
│   ├── models.py          # Pydantic モデル定義
│   ├── rules.py           # シフトルールチェック
│   └── solver.py          # シフト生成ソルバー
├── frontend/              # Next.js フロントエンド
│   └── app/
│       ├── page.tsx       # メインページ
│       ├── components/    # UIコンポーネント
│       ├── utils/         # ユーティリティ関数
│       ├── types.ts       # TypeScript型定義
│       └── constants.ts   # 定数定義
└── docs/
    └── SPECIFICATION.md   # 本仕様書
```

---

## 2. シフト種別

| 記号 | 名称 | 説明 |
|------|------|------|
| 早 | 早番 | 日勤帯シフト（早朝〜午後） |
| 日 | 日勤 | 日勤帯シフト（標準時間） |
| 遅 | 遅番 | 日勤帯シフト（午後〜夜間） |
| 夜 | 夜勤 | 夜間シフト（夜〜翌朝） |
| ・ | 明け | 夜勤翌日の休息日（勤務扱い） |
| ◎ | 公休 | 通常の休日 |
| ◎  | 希望休 | スタッフの希望による休日（末尾スペースで区別） |
| 有 | 有休 | 有給休暇 |
| リ休 | リフレッシュ休暇 | リフレッシュ休暇 |

---

## 3. スタッフ属性

| 属性値 | 名称 | 説明 |
|--------|------|------|
| 0 | 常勤 | 夜勤可能。全シフト対応可能 |
| 1 | パート（日勤のみ） | 日勤のみ固定 |
| 2 | パート（早番のみ） | 早番のみ固定 |

---

## 4. シフトルール

### 4.1 基本ルール

#### ルール1: 明け翌日は公休
- 「・」（明け）の翌日は必ず「◎」（公休）
- 前月末が「・」の場合、1日目は「◎」

#### ルール2: 夜勤翌日は明け
- 「夜」の翌日は必ず「・」（明け）
- 前月末が「夜」の場合、1日目は「・」、2日目は「◎」

### 4.2 逆行禁止ルール

以下のシフト遷移は禁止：

| 前日 | 翌日（禁止） |
|------|------------|
| 日 | 早 |
| 遅 | 早 |
| 遅 | 日 |

### 4.3 連勤ルール

| ルール | 内容 |
|--------|------|
| 最大連勤 | 5連勤まで（6連勤以上禁止） |
| 日勤帯のみ連勤 | **3連勤まで**（常勤のみ） |
| 5連勤パターン | 常勤が5連勤する場合は「夜・」を含む必要あり |

**5連勤の例：** `早 → 日 → 遅 → 夜 → ・` → `◎`（公休）

### 4.4 前月連勤考慮

- 前月末からの連勤日数（`prev_streak`）を月初の連勤計算に加算
- 前月末シフトが日勤帯の場合、日勤帯連勤カウントにも加算

---

## 5. シフト生成アルゴリズム

### 5.1 処理フェーズ

| Phase | 名称 | 処理内容 |
|-------|------|---------|
| 0 | 前月末処理 | 前月末シフトに基づく1日目の強制設定 |
| 1 | 固定・希望設定 | 年始固定シフト、希望休、有休、リ休、希望シフトの配置 |
| 2 | 夜勤希望配置 | 夜勤希望日への夜勤配置 |
| 3 | 毎日夜勤配置 | 全日に夜勤を1名ずつ配置 |
| 4 | 早番・遅番配置 | 全日に早番・遅番を各1名配置 |
| 5 | 日勤埋め | 空きスロットを日勤で埋める（平準化考慮） |
| 6 | 公休配置 | 残りの空きスロットに公休を配置 |
| 7 | 人員平準化 | 日別人員数の偏りを調整 |
| 8 | 不足解消 | 早番・遅番・日勤帯不足の解消 |
| 9 | 重複調整 | 早番・遅番が複数いる日を調整 |

### 5.2 固定日（変更不可）

以下の日は「固定日」として後のフェーズで変更されません：

- 希望休（`req_off`）
- 有休（`paid_leave_days`）
- リフレッシュ休暇（`refresh_days`）
- 希望シフト（`req_early`, `req_late`, `req_day`, `req_night`）
- 前月末シフトによる強制設定

### 5.3 スコアリング

| 評価項目 | ペナルティ |
|---------|----------|
| 公休数の目標との差 | 差 × 100 |
| 夜勤目標との差 | 差 × 50 |
| 早番欠員日 | 日数 × 300 |
| 遅番欠員日 | 日数 × 300 |
| 夜勤欠員日 | 日数 × 500 |
| 日勤帯3名未満の日 | 日数 × 100 |
| 人員数の分散 | 分散 × 30 |
| 人員数の最大最小差が3以上 | 差 × 50 |

### 5.4 試行回数

- デフォルト: 2500回
- 最大: 10000回
- 十分なスコアで早期終了

---

## 6. API仕様

### 6.1 シフト作成 API

**Endpoint:** `POST /api/shift/solve`

**Request Body:**
```json
{
  "year": 2026,
  "month": 2,
  "target_off_days": 9,
  "staff_data": [
    {
      "name": "山田太郎",
      "type": 0,
      "night_target": 4,
      "req_night": [5, 15],
      "req_early": [],
      "req_late": [],
      "req_day": [],
      "req_off": [10, 20],
      "refresh_days": [],
      "paid_leave_days": [25],
      "prev_shift": "◎",
      "prev_streak": 0,
      "fixed_shifts": ["", "", ""]
    }
  ],
  "max_attempts": 2500
}
```

**Response:**
```json
{
  "schedule": {
    "山田太郎": ["早", "日", "遅", "夜", "・", "◎", ...]
  },
  "errors": ["12日: 早番を配置できませんでした"],
  "year": 2026,
  "month": 2,
  "days": 28
}
```

### 6.2 日付パース API

**Endpoint:** `POST /api/shift/parse-days`

**Request Body:**
```json
{
  "input_str": "1,2,3,10,20"
}
```

**Response:**
```json
{
  "days": [1, 2, 3, 10, 20]
}
```

---

## 7. フロントエンド機能

### 7.1 主要機能

| 機能 | 説明 |
|------|------|
| シフト設定 | 年月、公休日数の設定 |
| スタッフ管理 | スタッフの追加・削除・編集 |
| 個人設定 | 各スタッフの希望シフト・休暇設定 |
| シフト作成 | APIを呼び出してシフト表を生成 |
| 確認ポイント表示 | 生成結果の問題点を表示 |
| CSVダウンロード | 生成したシフト表をCSV形式でダウンロード |
| 設定ファイル保存/読込 | JSON形式で設定を保存・読込 |

### 7.2 UI構成

| コンポーネント | ファイル | 役割 |
|--------------|---------|------|
| ShiftSettingsPanel | `ShiftSettingsPanel.tsx` | 基本設定パネル |
| StaffSettingsPanel | `StaffSettingsPanel.tsx` | スタッフ管理パネル |
| FileSettingsPanel | `FileSettingsPanel.tsx` | ファイル入出力パネル |
| ShiftTable | `ShiftTable.tsx` | シフト表の表示 |
| ShiftLegend | `ShiftLegend.tsx` | 凡例 |
| ValidationWarnings | `ValidationWarnings.tsx` | 警告表示 |
| CSVDownloadButton | `CSVDownloadButton.tsx` | CSVダウンロード |
| MiniCalendar | `MiniCalendar.tsx` | 日付選択カレンダー |

---

## 8. 設定ファイル形式

### 8.1 フル設定ファイル

```json
{
  "save_type": "full",
  "input_year": 2026,
  "input_month": 2,
  "target_off": 9,
  "staff_list_save": [
    { "name": "山田太郎", "type": 0 }
  ],
  "prev_山田太郎": "◎",
  "streak_山田太郎": 0,
  "night_山田太郎": 4,
  "req_n_山田太郎": "5,15",
  "req_e_山田太郎": "",
  "req_l_山田太郎": "",
  "req_d_山田太郎": "",
  "off_山田太郎": "10,20",
  "ref_山田太郎": "",
  "paid_山田太郎": "25"
}
```

### 8.2 スタッフのみファイル

```json
{
  "save_type": "staff_only",
  "staff_list_save": [
    { "name": "山田太郎", "type": 0 },
    { "name": "鈴木花子", "type": 1 }
  ]
}
```

---

## 9. 制限事項・注意点

### 9.1 アルゴリズムの制限

- 複雑な制約が重なると、すべてのルールを満たせない場合があります
- 毎回異なるパターンが生成されるため、**複数回試行して最良の結果を選択**することを推奨
- 生成結果は「下書き」として使用し、必要に応じて手動で調整してください

### 9.2 推奨環境

- **ブラウザ:** Chrome, Firefox, Safari, Edge（最新版）
- **Python:** 3.11以上
- **Node.js:** 18以上

---

## 10. 開発・運用

### 10.1 バックエンド起動

```bash
cd pes
uvicorn api:app --reload --host 0.0.0.0 --port 8000
```

### 10.2 フロントエンド起動

```bash
cd pes/frontend
npm install
npm run dev
```

### 10.3 本番デプロイ

```bash
# フロントエンド
npm run build
npm start

# バックエンド
uvicorn api:app --host 0.0.0.0 --port 8000 --workers 4
```

---

## 11. 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025-12-25 | 2.0.0 | リファクタリング、モジュール分割 |
| 2025-12-25 | 1.x | 初期実装 |

---

## 12. ライセンス

© 2025 Shift Manager Pro. All Rights Reserved.

